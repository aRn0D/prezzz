<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Quelle différence y a-t-il entre le bon et le mauvais repository?</title>

		<meta name="description" content="repository pattern ">
		<meta name="author" content="Arnaud Langlade">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/sky.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<style>
			.reveal .slides > section {
				padding: 0;
			}

			.reveal section img {
				border: none;
				box-shadow: none;
			}

			.reveal section .margin-left {
				margin-left: 100px;
			}

			.reveal section .margin-top {
				margin-top: 60px;
			}

			.reveal pre {
				box-shadow: none;
				margin: auto;
				width: 100%;
			}

			.reveal pre code {
				font-size: 30px;
				line-height: 32px;
				max-height: none;
			}

			.reveal .social {
				font-size: 60px;
			}

			.reveal .social img {
				margin-top: 0;
				margin-bottom: 0;
				vertical-align: middle;
			}

			.akeneo-color {
				color: #9452BA;
			}

			.sylius-color {
				color: #1abb9c;
			}

			.php-color {
				color: #6C7EB7;
			}

			.reveal p.social {
				margin: 100px 0;
			}

		</style>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h2><span class="akeneo-color">bad</span> or <span class="sylius-color">good</span> repository?</h2>
				</section>

				<section>
					<h1>Hi, I am <strong class="php-color">Arnaud!</strong></h1>

					<p class="margin-top">
						<img src="images/common/akeneo-large.png" height="140">
						<img src="images/common/sylius-large.png" height="140" class="margin-left">
					</p>
					<aside class="notes">
					My name is Arnaud Langlade and I am a developer. I work for <a href="https://www.akeneo.com/">Akeneo</a>: a french company which makes a Product Information Management. I was member of the <a href="https://www.sylius.com/">Sylius</a>  core team few years ago.
					</aside>
				</section>

                <section>
                    <h2>What is a <strong class="php-color">repository</strong>?</h2>
                    <blockquote class="fragment">
                        &laquo;A <strong class="sylius-color">repository</strong> behaves like a in memory collection of unique domain object without taking care about the storage&raquo;
                    </blockquote>
                </section>

                <section>
					<h2>Let's model a <span class="sylius-color">Galinette</span>!</h2>
					<img src="images/repository-galinette/dede.png">
					<p><strong class="sylius-color">Dédé, Business Expert</strong> <span class="akeneo-color">@BouchonnoisCorp</span></p>
					<aside class="notes">
						First, we need a domain object: a galinette! Before coding, we need to ask information to our business expert Dédé (seasoned hunter) about the Galienette cendrée. We asked a simple question to him: what is a galinette? He answered that a galinette is a bird that borns someday and then it meets a good hunter. Then he laughed and he have a drink....
					</aside>
				</section>

                <section>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Domain;

							final class Galinette
							{
								private $identifier;
								private $birthday;
								private $name;
								private $gender;
								private $goToHeavenAt;

								// constructor ...

								public static function born(
									Identifier $identifier,
									Birthday $birthday,
									Name $name,
									Gender $gender
								): Galinette {
									return new self($identifier, $birthday, $name, $gender);
								}

								public function goToHeaven(): void
								{
									$this->goToHeavenAt = new \DateTimeImmutable('NOW');
								}
							}
						</code>
					</pre>
					<aside class="notes">
						Dédé did not want reveal all his secret about the galinette but he said us enough information to design a domain object. This object have a named construct called "born". A named constructor is a static method used to build a object instead of using the default constructor. We don't used it because we don't create or build a galinette it borns, this name is related to the business we want to design. The last information given by Dédé is that a galinette go to the heaven someday and we need to store when it happens.
					</aside>
				</section>

				<section>
					<h2><h2>The bad <strong class="php-color">repository</strong></h2></h2>
				</section>

				<section>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Domain;

							interface GalinetteRepository
							{
								public function find(int $id): Galinette

								public function countGalinette(): int

								public function findGalinetteForARelease(): Galinette[];

								public function findGalinetteIdentifierForAReleaseAsString(): string[];
							}
						</code>
					</pre>
					<aside class="notes">
						Lot of applications have repositories which looks like this one. To be honest, I wrote a lot of repositories like this one. This repository have several methods that returns either a Domain object (Galinette) or scalar or array
					</aside>
				</section>
				<section>
					<h2>These are not <span class="php-color">repositories</span>!</h2>
					<p class="fragment">They are more <strong class="sylius-color">SQL query</strong> repositories</p>
					<aside class="notes">
						We use repository like a collection of SQL queries, we just use them to get get information. It does not match the definition you gave previously. It does not ack like a domain object collection because we cannot add anything to it.
					</aside>
				</section>


				<section>
					<h2>The good <strong class="php-color">repository</strong></h2>
					<p class="fragment">Let's use <strong class="sylius-color">doctrine</strong> to design it</p>
				</section>

				<section>
					<h2>Public <strong class="php-color">API</strong></h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Domain;

							interface GalinetteRepository
							{
								/**
								 * @throws \LogicException
								 */
								public function add(Domain\Galinette $galinette): void;

								/**
								 * @throws UnknownGalinette | \LogicException
								 */
								public function get(Domain\Identifier $identifier): Domain\Galinette;

								/**
								 * @throws \LogicException
								 */
								public function remove(Domain\Identifier $identifier): void;

								/**
								 * @throws \LogicException
								 */
								public function nextIdentity(): Domain\Identifier;
							}
						</code>
					</pre>
					<aside class="notes">
						A repository looks like a collection so we need a method to a add a domain object (Galinette) to the repository. Then with a the get we can access to the object we added to it. the method remove allow to delete a object with its identifier. The last method nextIdentifier generates a domain object identifier. It is useful to use uuid to avoid coupling between the database and our application. A uuid is made with the current time and a mac address, this is something to infrastructure layer. That is why the repository generates it!
					</aside>
				</section>

				<section>
					<h2>Repository <span class="php-color">dependencies</span></h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							use BouchonnoisCorp\Domain\GalinetteRepository;

							final class GalinetteRepository implements GalinetteRepository
							{
								private $entityManager;

								public function __construct(EntityManagerInterface $entityManager)
								{
									$this->entityManager = $entityManager;
								}

								// ...
							}
						</code>
					</pre>
                    <aside class="notes">
                        The repository does not need anymore to extends the Doctrine EntityRepository but it only need to depend the Doctrine EntityManager. The repository belongs the infrastructure layer but it implements an interface define in the domain layer.
                    </aside>
				</section>

				<section>
					<h2><span class="php-color">Add</span> a galinette</h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								// ...

								public function add(Domain\Galinette $galinette)
								{
									try {
										$this->entityManager->persist($galinette);
										$this->entityManager->flush($galinette);
									} catch (ORMInvalidArgumentException | ORMException $e) {
										throw new \LogicException('It is not possible to add this galinette');
									}
								}

								// ...
							}
						</code>
					</pre>
					<aside class="notes">
						First, we need to able to add a domain object (Galinette) the repository. This method ask to the entity manager to persist this object. That means that the entity manager will track all changes apply to this object. When we will call the flush method they will record in the database. Be careful, some exception might be thrown by the entity manager! We have to catch them and throw a LogicException to respect the contract define by GalinetteRepository.
					</aside>
				</section>

				<section>
					<h2><span class="php-color">Retrieve</span> a galinette</h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								// ...

								public function get(Domain\Identifier $identifier): Domain\Galinette
								{
									try {
										$galinette = $this->entityManager->find(Galinette::class, $identifier);
									} catch (ORMInvalidArgumentException | ORMException $e) {
										throw new \LogicException('It is not possible to add this galinette');
									} finally {
										if (null === $galinette) {
											throw new Exception\UnknownGalinette(
												(string) $identifier,
												Galinette::class
											);
										}

										return $galinette;
									}
								}

								// ...
							}
						</code>
					</pre>
					<aside class="notes">
						Then, we may need to get the Galinette we previously added to the repository. the entity manager is able to get data from the database and map them to an object thank to an domain object identifier and its FQCN.
					</aside>
				</section>

				<section>
					<h2><span class="php-color">Remove</span> a galinette</h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								// ...

								public function remove(Domain\Identifier $identifier)
								{
									try {
										$galinette = $this->entityManager->getReference(
											Domain\Galinette::class,
											(string) $identifier
										);

										$this->entityManager->remove($galinette);
										$this->entityManager->flush($galinette);
									} catch (ORMInvalidArgumentException | ORMException $e) {
										throw new \LogicException('It is not possible to remove this galinette');
									}
								}

								// ...
							}
						</code>
					</pre>
					<aside class="notes">
						T
					</aside>
				</section>

				<section>
					<h2>Get the <span class="php-color">next identity</span></h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								// ...

								public function nextIdentity(): Domain\Identifier
								{
							        try {
										return new Domain\Identifier(Uuid::uuid4()->toString());
									} catch (\InvalidArgumentException $e) {
										throw new \LogicException('It is not possible to build the next identity');
									}
								}
							}
						</code>
					</pre>
				</section>

				<section>
					<h2>How to manage my <span class="php-color">SQL queries</span>?</h2>
					<p class="fragment">
						With a <strong class="sylius-color"><strong>query function</strong></strong>: a class which represents a SQL query.
					</p>
				</section>

				<section>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine\Query;

							final class ReleaseOfGalinette implements Query\ReleaseOfGalinette
							{
								private $entityManager;

								public function __construct(EntityManagerInterface $entityManager)
								{
									$this->entityManager = $entityManager;
								}

								public function findGalinettes(): array
								{
									$select = sprintf(
										'NEW %s(g.identifier, g.name, g.birthday)',
										ReadModel\ReleaseOfGalinette::class
									);

									// NEW BouchonnoisCorp\Domain\ReadModel\ReleaseOfGalinette(g.identifier, ...)
									$query = $this->entityManager->createQueryBuilder()
										->select($select)
										->from(Galinette::class, 'g')
										->getQuery();

									return $query->execute();
								}
							}
						</code>
					</pre>
				</section>

				<section>
					<h2>What is a <strong class="akeneo-color">Read model</strong>?</h2>
					<blockquote class="fragment">
						&laquo;A <strong class="sylius-color">read model</strong> is a immutable model specialized for reads.&raquo;
					</blockquote>
				</section>

				<section>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Domain\ReadModel;

							final class ReleaseOfGalinette
							{
								private $identifier;
								private $name;
								private $birthday;

								public function __construct(
									Identifier $identifier,
									Name $name,
									Birthday $birthday
								) {
									$this->identifier = $identifier;
									$this->name = $name;
									$this->birthday = $birthday;
								}

								public function normalize(): array
								{
									return [
										'id' => (string) $this->identifier,
										'name' => (string) $this->name,
										'birthday' => (string) $this->birthday,
									];
								}
							}
						</code>
					</pre>
				</section>

				<section>
					<h2>Code example is <strong class="php-color">available</strong> on Github!</h2>
					<p>
						<a href="https://github.com/arnolanglade/galinette-repository">
							https://github.com/arnolanglade/galinette-repository
						</a>
					</p>
				</section>

				<section>
					<h2>Thank you! Questions?</h2>

					<p class="social">
						<img src="images/common/github.png" height="80"> arnolanglade <img src="images/common/twitter.png" height="80" class="margin-left"> arnolanglade
					</p>
					<p>
					https://joind.in/talk/todo
					</p>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
                width: 1600,
                height: 1100,
                controls: true,
                progress: true,
                history: true,
                center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); hljs.configure({tabReplace: '    '});} },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
