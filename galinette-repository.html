<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Quelle différence y a-t-il entre le bon et le mauvais repository?</title>

		<meta name="description" content="repository pattern ">
		<meta name="author" content="Arnaud Langlade">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/sky.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<style>
			.reveal .slides > section {
				padding: 0;
			}

			.reveal section img {
				border: none;
				box-shadow: none;
			}

			.reveal section .margin-left {
				margin-left: 100px;
			}

			.reveal section .margin-top {
				margin-top: 60px;
			}

			.reveal pre {
				box-shadow: none;
				margin: auto;
				width: 100%;
			}

			.reveal pre code {
				font-size: 30px;
				line-height: 32px;
				max-height: none;
			}

			.reveal .social {
				font-size: 60px;
			}

			.reveal .social img {
				margin-top: 0;
				margin-bottom: 0;
				vertical-align: middle;
			}

			.akeneo-color {
				color: #9452BA;
			}

			.sylius-color {
				color: #1abb9c;
			}

			.php-color {
				color: #6C7EB7;
			}

			.reveal p.social {
				margin: 100px 0;
			}

		</style>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h2><span class="akeneo-color">bad</span> or <span class="sylius-color">good</span> repository?</h2>
				</section>

				<section>
					<h1>Hi, I am <strong class="php-color">Arnaud!</strong></h1>

					<p class="margin-top">
						<img src="images/common/akeneo-large.png" height="140">
						<img src="images/common/sylius-large.png" height="140" class="margin-left">
					</p>
				</section>

                <section>
                    <h2>What is a <strong class="php-color">repository</strong>?</h2>
                    <blockquote class="fragment">
                        &laquo;A <strong class="sylius-color">repository</strong> behaves like a in memory collection of unique entities without taking care about the storage&raquo;
                    </blockquote>
                </section>

                <section>
					<h2>Let's modelize a <span class="sylius-color">Galinette</span>!</h2>
					<img src="images/repository-galinette/dede.png">
					<p><strong class="sylius-color">Dédé, Business Expert</strong> <span class="akeneo-color">@BouchonnoisCorp</span></p>
				</section>

                <section>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Domain;

							final class Galinette
							{
								private $identifier;
								private $birthday;
								private $name;
								private $gender;
								private $diedAt;

								public static function born(
									Identifier $identifier,
									Birthday $birthday,
									Name $name,
									Gender $gender
								): Galinette {
									return new self($identifier, $birthday, $name, $gender);
								}

								public function die(): void
								{
									$this->diedAt = new \DateTimeImmutable('NOW');
								}
							}
						</code>
					</pre>
				</section>

				<section>
					<h2><h2>The bad <strong class="php-color">repository</strong></h2></h2>
				</section>

				<section>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Domain;

							interface GalinetteRepository
							{
								public function find(int $id): Galinette

								public function countGalinette(): int

								public function findGalinetteForARelease(): Galinette[];

								public function findGalinetteIdentifierForAReleaseAsString(): string[];
							}
						</code>
					</pre>
				</section>
				<section>
					<h2>These are not <span class="php-color">repositories</span>!</h2>
					<p class="fragment">They are more <strong class="sylius-color">SQL query</strong> repositories</p>
				</section>


				<section>
					<h2>The good <strong class="php-color">repository</strong></h2>
					<p class="fragment">Let's use <strong class="sylius-color">doctrine</strong> to design it</p>
				</section>

				<section>
					<h2>Public <strong class="php-color">API</strong></h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							interface GalinetteRepository
							{
								public function get(Domain\Identifier $identifier): Domain\Galinette;

								public function add(Domain\Galinette $galinette): void;

								public function remove(Domain\Identifier $identifier): void;

								public function nextIdentity(): Domain\Identifier;
							}

						</code>
					</pre>
				</section>

				<section>
					<h2>Repository <span class="php-color">dependencies</span></h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								private $entityManager;

								public function __construct(EntityManagerInterface $entityManager)
								{
									$this->entityManager = $entityManager;
								}

								// ...
							}
						</code>
					</pre>
				</section>

				<section>
					<h2><span class="php-color">Add</span> a galinette</h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								// ...

								public function add(Domain\Galinette $galinette)
								{
									try {
										$this->entityManager->persist($galinette);
										$this->entityManager->flush($galinette);
									} catch (ORMInvalidArgumentException | ORMException $e) {
										throw new \LogicException('It is not possible to add this galinette');
									}
								}

								// ...
							}
						</code>
					</pre>
				</section>

				<section>
					<h2><span class="php-color">Remove</span> a galinette</h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								// ...

								public function remove(Domain\Identifier $identifier)
								{
									try {
										$galinette = $this->entityManager->getReference(
											Domain\Galinette::class,
											(string) $identifier
										);

										$this->entityManager->remove($galinette);
										$this->entityManager->flush($galinette);
									} catch (ORMInvalidArgumentException | ORMException $e) {
										throw new \LogicException('It is not possible to remove this galinette');
									}
								}

								// ...
							}
						</code>
					</pre>
				</section>

				<section>
					<h2><span class="php-color">Retrieve</span> a galinette</h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								// ...

								public function get(Domain\Identifier $identifier): Domain\Galinette
								{
									$employee = $this->entityManager->find(Domain\Galinette::class, $identifier)
									if (null === $employee) {
										throw new Exception\UnknownGalinette(
											(string) $identifier,
											Domain\Galinette::class
										);
									}

									return $employee;
								}

								// ...
							}
						</code>
					</pre>
				</section>

				<section>
					<h2>Get the <span class="php-color">next identity</span></h2>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine;

							final class GalinetteRepository implements GalinetteRepository
							{
								// ...

								public function nextIdentity(): Domain\Identifier
								{
									return new Domain\Identifier(Uuid::uuid4()->toString());
								}
							}
						</code>
					</pre>
				</section>

				<section>
					<h2>How to manage my <span class="php-color">SQL queries</span>?</h2>
					<p class="fragment">
						<strong class="sylius-color"><strong>Query function:</strong></strong> A class with a single method
					</p>
				</section>

				<section>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Infrastructure\Storage\Doctrine\Query;

							final class ReleaseOfGalinette implements Query\ReleaseOfGalinette
							{
								private $entityManager;

								public function __construct(EntityManagerInterface $entityManager)
								{
									$this->entityManager = $entityManager;
								}

								public function findGalinette(): array
								{
									$select = sprintf(
										'NEW %s(g.identifier, g.name, g.birthday)',
										ReadModel\ReleaseOfGalinette::class
									);

									// NEW BouchonnoisCorp\Domain\ReadModel\ReleaseOfGalinette(g.identifier, ...)
									$query = $this->entityManager->createQueryBuilder()
										->select($select)
										->from(Galinette::class, 'g')
										->getQuery();

									return $query->execute();
								}
							}
						</code>
					</pre>
				</section>

				<section>
					<h2>What is a <span class="akeneo-color">Read model</span>?</h2>
					<blockquote class="fragment">
						&laquo;A <strong class="sylius-color">read model</strong> Todo&raquo;
					</blockquote>
				</section>

				<section>
					<pre>
						<code class="php hljs" data-trim >
							namespace BouchonnoisCorp\Domain\ReadModel;

							final class ReleaseOfGalinette
							{
								private $identifier;
								private $name;
								private $birthday;

								public function __construct(
									Identifier $identifier,
									Name $name,
									Birthday $birthday
								) {
									$this->identifier = $identifier;
									$this->name = $name;
									$this->birthday = $birthday;
								}

								public function normalize(): array
								{
									return [
										'id' => (string) $this->identifier,
										'name' => (string) $this->name,
										'birthday' => (string) $this->birthday,
									];
								}
							}
						</code>
					</pre>
				</section>


				<section>
					<h2>Thank you! Questions?</h2>

					<p class="social">
						<img src="images/common/github.png" height="80"> arnolanglade <img src="images/common/twitter.png" height="80" class="margin-left"> arnolanglade
					</p>
					<p>
					https://joind.in/talk/todo
					</p>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
                width: 1600,
                height: 1100,
                controls: true,
                progress: true,
                history: true,
                center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); hljs.configure({tabReplace: '    '});} },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
